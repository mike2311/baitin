# BAITIN Trading Management System - Cursor Rules

## Core Principles

1. **Documentation-First Development**: All work MUST reference and align with existing documentation
2. **Original Logic Preservation**: NEVER deviate from original business logic and validation rules
3. **Strategic Alignment**: All implementations MUST follow the modernization strategy
4. **Feature Parity**: Maintain 100% feature parity with the original FoxPro system
5. **Phased Delivery**: Follow the phased delivery plan and current phase requirements

## Documentation Structure Reference

### Primary Documentation Locations
- **System Documentation**: `docs/00-overview/` through `docs/09-technical-details/`
- **Modernization Strategy**: `docs/modernization-strategy/`
- **Business Processes**: `docs/02-business-processes/`
- **Data Architecture**: `docs/01-data-architecture/`
- **Forms & Screens**: `docs/04-forms-and-screens/`
- **Business Logic**: `docs/05-business-logic/`

### Key Documents to Always Reference

#### Before Starting Any Task:
1. **System Summary**: `docs/00-overview/system-summary.md` - Understand overall system
2. **Current State Assessment**: `docs/modernization-strategy/02-current-state-assessment/current-state-assessment.md`
3. **Target Architecture**: `docs/modernization-strategy/03-target-state-architecture/target-state-architecture.md`
4. **Phased Delivery Plan**: `docs/modernization-strategy/11-phased-delivery-plan/phased-delivery-plan.md`

#### For Specific Modules:
- **Order Enquiry**: `docs/02-business-processes/order-enquiry-process.md`, `docs/03-application-modules/order-enquiry-module.md`
- **Master Data**: `docs/02-business-processes/master-data-management.md`
- **Workflows**: `docs/02-business-processes/workflow-overview.md`
- **Data Models**: `docs/01-data-architecture/table-details/`
- **Validation Rules**: `docs/04-forms-and-screens/validation-catalog.md`
- **Form Logic**: `docs/04-forms-and-screens/form-logic-patterns.md`

## Mandatory Pre-Implementation Checklist

Before implementing ANY feature, module, or component:

### 1. Documentation Review
- [ ] Read relevant documentation in `docs/` folder
- [ ] Review modernization strategy for the module
- [ ] Check phased delivery plan for current phase scope
- [ ] Review original business logic documentation
- [ ] Understand data model and relationships

### 2. Original Logic Analysis
- [ ] Identify original FoxPro forms/programs for the feature
- [ ] Extract all validation rules from original code
- [ ] Document all business rules that must be preserved
- [ ] Identify any special cases or exceptions (e.g., INSP company prefix)
- [ ] Map original data structures to new architecture

### 3. Strategic Alignment
- [ ] Verify feature is in scope for current phase
- [ ] Check UX/UI strategy requirements (`docs/modernization-strategy/06-ux-ui-strategy/ux-ui-strategy.md`)
- [ ] Review security requirements (`docs/modernization-strategy/07-security-compliance/security-compliance.md`)
- [ ] Check integration requirements (`docs/modernization-strategy/08-integration-strategy/integration-strategy.md`)
- [ ] Verify target architecture compliance

### 4. Validation Planning
- [ ] List all validation rules from original system
- [ ] Map validation rules to new implementation
- [ ] Plan test cases to verify original logic preservation
- [ ] Document any enhancements (must not break original logic)

## Business Logic Preservation Rules

### Critical Business Rules (MUST NOT CHANGE)

1. **OE Control Validation**:
   - OE must have control record in `moectrl` before import
   - Exception: INSP company adds "IN-" prefix automatically
   - Customer code must match between OE Control and import data
   - Reference: `docs/02-business-processes/order-enquiry-process.md` lines 44-69

2. **BOM Processing**:
   - Formula: `sub_item_qty = (head_qty * bom_qty) / total_bom_qty`
   - Items with BOM have `head = .T.` flag
   - Sub-items have `head = .F.` flag
   - Reference: `docs/05-business-logic/core-algorithms.md`

3. **Vendor Grouping**:
   - Contracts generated by grouping OC items by `vendor_no`
   - One contract per vendor per OC
   - Reference: `docs/02-business-processes/workflow-overview.md` lines 191-195

4. **Document Numbering**:
   - OE numbers: Format varies by company (HT uses "/", BAT doesn't)
   - Maintain original numbering logic
   - Reference: `docs/02-business-processes/workflow-overview.md` lines 196-201

5. **Quantity Tracking**:
   - OE quantities can have breakdowns (size/color/style)
   - Breakdowns stored in `mqtybrk`
   - Quantities flow: OE → OC → Contract → SO → Invoice
   - Reference: `docs/02-business-processes/workflow-overview.md` lines 203-207

6. **Status Transitions**:
   - OE: Draft → Processing → Posted → Confirmed
   - OC: Created → Confirmed → Contracted
   - Contract: Created → Sent → Confirmed → Shipped
   - Invoice: Created → Sent → Paid
   - Reference: `docs/02-business-processes/workflow-overview.md` lines 148-176

### Validation Rules (MUST PRESERVE)

All validation rules documented in `docs/04-forms-and-screens/validation-catalog.md` MUST be implemented exactly as specified. This includes:
- Field-level validations
- Cross-field validations
- Database validations
- Business rule validations

## Implementation Guidelines

### Code Structure
- Follow target architecture from `docs/modernization-strategy/03-target-state-architecture/target-state-architecture.md`
- Use React + TypeScript for frontend
- Use .NET or Node.js for backend (as per strategy)
- Use PostgreSQL for database

### UX Requirements
- **Keyboard-First Design**: All forms must support keyboard navigation
- **Auto-Advance**: Text inputs should auto-advance to next field
- **Type-to-Search**: Lookup fields must support type-to-search
- **Excel-Like Grids**: Use AG Grid for data entry grids
- **Performance**: < 500ms API response, < 2s page load
- Reference: `docs/modernization-strategy/06-ux-ui-strategy/ux-ui-strategy.md`

### Data Migration Considerations
- When working with data, reference `docs/modernization-strategy/04-data-migration-strategy/data-migration-strategy.md`
- Maintain all data relationships
- Preserve all field mappings
- Handle memo fields (FPT) conversion properly

### Security Requirements
- Implement authentication per `docs/modernization-strategy/07-security-compliance/security-compliance.md`
- Support roles: SUPERVISOR and REGULAR_USER
- Multi-company support (HT, BAT, INSP, HFW)
- Reference: `docs/00-overview/user-roles.md`

## Validation and Testing Requirements

### Before Submitting Code:

1. **Logic Validation**:
   - [ ] Verify all original business rules are implemented
   - [ ] Test all validation rules match original system
   - [ ] Verify data flow matches original workflows
   - [ ] Check exception handling (e.g., INSP company prefix)

2. **Documentation Alignment**:
   - [ ] Code comments reference relevant documentation
   - [ ] Implementation matches documented architecture
   - [ ] Follows phased delivery plan scope

3. **Feature Parity**:
   - [ ] All original features are present
   - [ ] No functionality removed or simplified
   - [ ] Enhancements don't break original logic

4. **Strategic Compliance**:
   - [ ] Follows UX/UI strategy
   - [ ] Meets security requirements
   - [ ] Aligns with integration strategy
   - [ ] Follows deployment operations plan

## Code Comments and Documentation

### Required Code Comments

Every significant function/component MUST include:
```typescript
/**
 * [Function/Component Description]
 * 
 * Original Logic Reference:
 * - FoxPro Form/Program: [form_name.scx or program.prg]
 * - Documentation: docs/[path]/[file].md
 * - Business Rule: [brief description]
 * 
 * Validation Rules:
 * - [Rule 1 from validation-catalog.md]
 * - [Rule 2 from validation-catalog.md]
 * 
 * Special Cases:
 * - [Any exceptions, e.g., INSP company prefix]
 * 
 * Modernization Notes:
 * - [Any enhancements or changes from original]
 */
```

### Example:
```typescript
/**
 * Validates OE Control record before OE import
 * 
 * Original Logic Reference:
 * - FoxPro Program: uoexls_2013.prg (lines 148-156)
 * - Documentation: docs/02-business-processes/order-enquiry-process.md
 * - Business Rule: OE must have control record, except INSP company
 * 
 * Validation Rules:
 * - OE Control record must exist in moectrl table
 * - Exception: INSP company adds "IN-" prefix automatically
 * - Customer code must match between OE Control and import data
 * 
 * Special Cases:
 * - INSP company: Automatically prefixes OE number with "IN-"
 * - Other companies: Must have existing moectrl record
 */
```

## Error Handling

### Error Messages
- Preserve original error message text where possible
- Reference original error messages from documentation
- Maintain user-friendly error handling

### Validation Errors
- All validation errors must match original system behavior
- Reference `docs/04-forms-and-screens/validation-catalog.md` for error messages
- Display errors in user-friendly format (modern UX)

## Phased Delivery Compliance

### Current Phase Check
Before implementing any feature:
1. Check `docs/modernization-strategy/11-phased-delivery-plan/phased-delivery-plan.md`
2. Verify feature is in scope for current phase
3. If not in current phase, document for future phase

### Phase 0 (Foundation):
- Infrastructure setup only
- Core components
- No business logic implementation

### Phase 1 (PoC):
- Master Data Management
- Order Enquiry (core only)
- Reference: `docs/modernization-strategy/15-poc-strategy/poc-strategy.md`

### Phase 2 (MVP):
- Order Enquiry (complete)
- Order Confirmation
- Contract
- Reference: Phased Delivery Plan

### Phase 3+ (Full Feature Set):
- Shipping Order
- Delivery Note
- Invoice
- Reporting
- All remaining modules

## Anti-Patterns (DO NOT DO)

1. **DO NOT** implement features without checking documentation first
2. **DO NOT** change business logic without documenting why
3. **DO NOT** skip validation rules from original system
4. **DO NOT** implement features outside current phase scope
5. **DO NOT** remove functionality to "simplify"
6. **DO NOT** ignore special cases (e.g., INSP company prefix)
7. **DO NOT** deviate from target architecture
8. **DO NOT** implement without preserving original data relationships
9. **DO NOT** create new business rules without approval
10. **DO NOT** skip testing against original logic

## When in Doubt

1. **Read Documentation First**: Check `docs/` folder for relevant information
2. **Check Original Logic**: Review original FoxPro code if available
3. **Reference Strategy**: Check modernization strategy documents
4. **Preserve Over Enhance**: When unsure, preserve original logic
5. **Document Decisions**: If deviating, document why and get approval

## Success Criteria

Every implementation is successful when:
- ✅ All original business logic is preserved
- ✅ All validation rules match original system
- ✅ Documentation is referenced and followed
- ✅ Strategic requirements are met
- ✅ Feature parity is maintained
- ✅ Code is well-documented with references
- ✅ Tests validate original logic preservation
- ✅ Current phase scope is respected

## Quick Reference

### Documentation Index
- System Overview: `docs/README.md`
- Modernization Strategy: `docs/modernization-strategy/README.md`
- Workflow Overview: `docs/02-business-processes/workflow-overview.md`
- Application Modernization: `docs/modernization-strategy/05-application-modernization/application-modernization.md`
- UX Strategy: `docs/modernization-strategy/06-ux-ui-strategy/ux-ui-strategy.md`
- Data Migration: `docs/modernization-strategy/04-data-migration-strategy/data-migration-strategy.md`
- Phased Plan: `docs/modernization-strategy/11-phased-delivery-plan/phased-delivery-plan.md`

### Critical Files to Always Check
1. `docs/00-overview/system-summary.md` - System understanding
2. `docs/02-business-processes/workflow-overview.md` - Workflow understanding
3. `docs/modernization-strategy/05-application-modernization/application-modernization.md` - Module details
4. `docs/04-forms-and-screens/validation-catalog.md` - Validation rules
5. `docs/05-business-logic/core-algorithms.md` - Core algorithms

